pipeline {
    agent any

    environment {
        API_PORT = '4000'
    }

    stages {

        stage('Checkout') {
            steps {
                // Obtiene el cÃ³digo desde el repo configurado en el job
                checkout scm
            }
        }

        stage('Backend Build & Seed') {
            steps {
                dir('server') {
                    bat 'npm ci'
                    bat 'npm run seed'
                }
            }
        }

        stage('API Healthcheck') {
            steps {
                dir('server') {
                    // Levanta la API en segundo plano
                    bat 'start /b npm start'
                }
                // Espera unos segundos a que arranque
                bat 'ping 127.0.0.1 -n 5 > nul'
                // Healthcheck a la API
                bat 'curl -f http://localhost:%API_PORT%/api/health'
            }
        }

        stage('Frontend Build') {
            steps {
                dir('web') {
                    bat 'npm ci'
                    bat 'npm run build'
                }
            }
        }

stage('API Tests (Newman)') {
    steps {
        dir("${env.WORKSPACE}") {
            bat '''
npx newman run postman\\QA-demo.postman_collection.json ^ -e postman\\QA-demo.postman_environment.json ^ -r junit --reporter-junit-export newman.xml || exit 0
            '''
        }
    }
    post {
        always {
            junit 'newman.xml'
        }
    }
}


        stage('UI E2E (Selenium)') {
            steps {
                dir('2e2') {
                    bat 'mvn test'
                }
            }
            post {
                always {
                    // Publica los reportes de pruebas de Maven/Selenium
                    junit '2e2\\target\\surefire-reports\\*.xml'
                }
            }
        }
    }

    post {
        always {
            // Intenta cerrar cualquier proceso node que haya quedado vivo
            bat 'taskkill /IM node.exe /F || exit /B 0'
        }
    }
}
