pipeline {
    agent any

    environment {
        API_PORT = '4000'
    }

    stages {

        stage('Checkout') {
            steps {
                // Si usas SCM (GitHub/GitLab), Jenkins rellenará esto solo con "checkout scm"
                checkout scm
            }
        }
        

        // PRUEBA 1: build del backend + seed de la base
        stage('Backend Build & Seed') {
            steps {
                dir('server') {
                    bat 'npm ci'
                    bat 'npm run seed'
                }
            }
        }

        // PRUEBA 2: levantar API y hacer healthcheck
        stage('API Healthcheck') {
            steps {
                dir('server') {
                    // Levanta la API en segundo plano
                    bat 'start /b npm start'
                }
                // Darle un tiempito para que arranque
                bat 'ping 127.0.0.1 -n 5 > nul'
                // Healthcheck
                bat "curl -f http://localhost:${API_PORT}/api/health"
            }
        }

        // PRUEBA 3: build del frontend
        stage('Frontend Build') {
            steps {
                dir('web') {
                    bat 'npm ci'
                    bat 'npm run build'
                }
            }
        }

        // PRUEBA 4: ejecutar colección Postman con Newman
        stage('API Tests (Newman)') {
            steps {
                // Instalar newman si no está
                bat '''
IF NOT EXIST "%APPDATA%\\npm\\newman.cmd" (
  npm install -g newman
)
newman run postman\\QA-demo.postman_collection.json ^
  -e postman\\QA-demo.postman_environment.json ^
  -r junit --reporter-junit-export newman.xml
                '''
            }
            post {
                always {
                    junit 'newman.xml'
                }
            }
        }

        // PRUEBA 5: ejecutar pruebas E2E de Selenium
        stage('UI E2E (Selenium)') {
            steps {
                dir('e2e') {
                    bat 'mvn test'
                }
            }
            post {
                always {
                    junit 'e2e\\target\\surefire-reports\\*.xml'
                }
            }
        }
    }

    post {
        always {
            // Intentar matar procesos node que hayan quedado
            bat 'taskkill /IM node.exe /F || exit /B 0'
        }
    }
}
